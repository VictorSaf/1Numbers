version: '3.9'

services:
  # ========================================================================
  # Ollama - Local LLM Inference
  # ========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: 1numbers-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      # Keep model in memory for 24 hours
      OLLAMA_KEEP_ALIVE: 24h
    command: serve
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ========================================================================
  # PostgreSQL - Primary Database
  # ========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: 1numbers-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: numerology
      POSTGRES_USER: numerology_user
      POSTGRES_PASSWORD: ${DB_PASSWORD:-secure_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/sql/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U numerology_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================================================
  # Redis - Cache Layer
  # ========================================================================
  redis:
    image: redis:7-alpine
    container_name: 1numbers-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --loglevel notice
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================================================
  # Weaviate - Vector Database (RAG)
  # ========================================================================
  weaviate:
    image: semitechnologies/weaviate:latest
    container_name: 1numbers-weaviate
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_APIKEY_ENABLED: "false"
      PERSISTENCE_DATA_PATH: "/var/lib/weaviate"
    volumes:
      - weaviate_data:/var/lib/weaviate
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/.well-known/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================================================
  # FastAPI Backend
  # ========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: 1numbers-backend
    ports:
      - "8000:8000"
    environment:
      # FastAPI
      FASTAPI_HOST: 0.0.0.0
      FASTAPI_PORT: 8000
      FASTAPI_RELOAD: "false"
      DEBUG: "false"

      # Ollama
      OLLAMA_BASE_URL: http://ollama:11434
      OLLAMA_MODEL: mistral-nemo
      OLLAMA_EMBEDDING_MODEL: nomic-embed-text

      # Database
      DATABASE_URL: postgresql://numerology_user:${DB_PASSWORD:-secure_password}@postgres:5432/numerology

      # Redis
      REDIS_URL: redis://redis:6379/0

      # Weaviate
      WEAVIATE_URL: http://weaviate:8080
      WEAVIATE_GRPC_URL: weaviate:50051

      # Security
      SECRET_KEY: ${SECRET_KEY:-your-super-secret-key-change-in-production}
      ENVIRONMENT: ${ENVIRONMENT:-development}

    volumes:
      - ./backend:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      weaviate:
        condition: service_healthy
      ollama:
        condition: service_healthy
    command: uvicorn main:app --host 0.0.0.0 --port 8000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================================================
  # React Frontend
  # ========================================================================
  frontend:
    build:
      context: ./
      dockerfile: Dockerfile
    container_name: 1numbers-frontend
    ports:
      - "3000:5173"
    environment:
      VITE_API_URL: http://localhost:8000
      VITE_WS_URL: ws://localhost:8000
    depends_on:
      - backend
    volumes:
      - .:/app

volumes:
  ollama_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local
  weaviate_data:
    driver: local

networks:
  default:
    name: 1numbers-network
    driver: bridge
